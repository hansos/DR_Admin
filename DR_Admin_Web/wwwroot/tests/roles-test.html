<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Roles API Test - DR Admin</title>
  <link href="/lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/assets/css/test-page.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="/choose-test.html">DR Admin - Roles API</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><span id="userInfo" class="user-info"></span></li>
          <li class="nav-item"><a href="/choose-test.html" class="btn btn-back">&#8592; Back to Tests</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-main">
    <div class="header-card">
      <h1>&#128100; Roles API Test</h1>
      <p>Standard CRUD operations for Roles</p>
    </div>

    <div id="alertContainer"></div>

    <div class="test-section">
      <h2 class="section-title">&#10133; Create Role</h2>
      <form id="createForm">
        <div class="mb-3">
          <label for="createName" class="form-label">Name *</label>
          <input id="createName" class="form-control" required />
        </div>
        <div class="mb-3">
          <label for="createDescription" class="form-label">Description</label>
          <textarea id="createDescription" class="form-control" rows="2"></textarea>
        </div>
        <button class="btn btn-primary" type="submit">Create Role</button>
      </form>
    </div>

    <div class="test-section">
      <h2 class="section-title">&#128203; Get All Roles</h2>
      <button class="btn btn-primary mb-3" onclick="getAllRoles()">Load All Roles</button>
      <div class="loading" id="loadingAll"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>
      <div id="rolesTable"></div>
    </div>

    <div class="test-section">
      <h2 class="section-title">&#128269; Get Role by ID</h2>
      <div class="row">
        <div class="col-md-4 mb-3">
          <input id="getRoleId" class="form-control" placeholder="Enter ID" />
        </div>
        <div class="col-md-8 d-flex align-items-end">
          <button class="btn btn-primary" onclick="getRoleById()">Get Role</button>
        </div>
      </div>
      <div class="loading" id="loadingById"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>
      <div id="roleByIdResult"></div>
    </div>

    <div class="test-section">
      <h2 class="section-title">&#128225; Last API Response</h2>
      <div class="response-box" id="responseBox">No API calls made yet...</div>
    </div>
  </div>

  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">&#9998; Edit Role</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <input type="hidden" id="editId" />
            <div class="mb-3">
              <label class="form-label">Name *</label>
              <input id="editName" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea id="editDescription" class="form-control" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="updateRole()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/js/authClient.js"></script>
  <script>
    let currentRoles = [];
    let editModal;

    window.addEventListener('DOMContentLoaded', async () => {
      const token = authClient.getToken(); if (!token) { window.location.href = '/login.html'; return; }
      const r = await authClient.verifyToken(); if (r.authenticated && r.data?.username) document.getElementById('userInfo').textContent = `Hello, ${r.data.username}!`;
      editModal = new bootstrap.Modal(document.getElementById('editModal'));
      document.getElementById('createForm').addEventListener('submit', handleCreate);
      getAllRoles();
    });

    function showAlert(message, type='info') { const c = document.getElementById('alertContainer'); c.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`; setTimeout(()=>{ const a=c.querySelector('.alert'); if (a) bootstrap.Alert.getOrCreateInstance(a).close(); },5000); }
    function updateResponseBox(data) { document.getElementById('responseBox').textContent = JSON.stringify(data, null, 2); }
    function getAuthHeaders() { const token = authClient.getToken(); return {'Content-Type':'application/json','Authorization': `Bearer ${token}`}; }

    async function handleCreate(e) {
      e.preventDefault();
      const data = { name: document.getElementById('createName').value.trim(), description: document.getElementById('createDescription').value.trim() || null };
      try {
        const res = await fetch(`${API_BASE_URL}/api/v1/Roles`, { method:'POST', headers: getAuthHeaders(), body: JSON.stringify(data) });
        let result; const ct = res.headers.get('content-type'); if (ct && ct.includes('application/json')) result = await res.json(); else { const t = await res.text(); result = { error: t, statusCode: res.status }; }
        updateResponseBox(result);
        if (res.ok) { showAlert('Role created','success'); document.getElementById('createForm').reset(); getAllRoles(); } else showAlert(`Error: ${result.message||result.error||'Failed to create'}`,'danger');
      } catch (err) { showAlert(`Error: ${err.message}`,'danger'); updateResponseBox({ error: err.message }); }
    }

    async function getAllRoles() {
      const loading = document.getElementById('loadingAll'); const container = document.getElementById('rolesTable'); loading.style.display='block'; container.innerHTML='';
      try {
        const res = await fetch(`${API_BASE_URL}/api/v1/Roles`, { method:'GET', headers: getAuthHeaders() });
        let data; const ct = res.headers.get('content-type'); if (ct && ct.includes('application/json')) data = await res.json(); else { const t = await res.text(); data = { error: t, statusCode: res.status }; }
        updateResponseBox(data);
        if (res.ok) { currentRoles = data; renderRolesTable(data); } else showAlert(`Error: ${data.message||data.error||'Failed to fetch'}`,'danger');
      } catch (err) { showAlert(`Error: ${err.message}`,'danger'); updateResponseBox({ error: err.message }); } finally { loading.style.display='none'; }
    }

    function renderRolesTable(items) {
      const container = document.getElementById('rolesTable'); if (!items || items.length===0) { container.innerHTML = '<div class="empty-state">No roles found</div>'; return; }
      const html = `<div class="table-responsive"><table class="table"><thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Actions</th></tr></thead><tbody>${items.map(i=>`<tr><td>${i.id}</td><td>${i.name}</td><td>${i.description||'-'}</td><td><button class="btn btn-sm btn-warning" onclick="openEditModal(${i.id})">Edit</button> <button class="btn btn-sm btn-danger" onclick="deleteRole(${i.id}, '${(i.name||'').replace(/'/g, "\\'" )}')">Delete</button></td></tr>`).join('')}</tbody></table></div>`;
      container.innerHTML = html;
    }

    async function getRoleById() {
      const id = document.getElementById('getRoleId').value; if (!id) { showAlert('Please enter an ID','warning'); return; }
      const loading = document.getElementById('loadingById'); const result = document.getElementById('roleByIdResult'); loading.style.display='block'; result.innerHTML='';
      try {
        const res = await fetch(`${API_BASE_URL}/api/v1/Roles/${id}`, { method:'GET', headers: getAuthHeaders() });
        let data; const ct = res.headers.get('content-type'); if (ct && ct.includes('application/json')) data = await res.json(); else { const t = await res.text(); data = { error: t, statusCode: res.status }; }
        updateResponseBox(data);
        if (res.ok) { result.innerHTML = `<div class="alert alert-success"><h5>Role:</h5><p><strong>ID:</strong> ${data.id}</p><p><strong>Name:</strong> ${data.name}</p><p><strong>Description:</strong> ${data.description||'N/A'}</p></div>`; } else showAlert(`Error: ${data.message||data.error||'Not found'}`,'danger');
      } catch (err) { showAlert(`Error: ${err.message}`,'danger'); updateResponseBox({ error: err.message }); } finally { loading.style.display='none'; }
    }

    function openEditModal(id) { const item = currentRoles.find(x=>x.id===id); if (!item) { showAlert('Role not found','danger'); return; } document.getElementById('editId').value=item.id; document.getElementById('editName').value=item.name||''; document.getElementById('editDescription').value=item.description||''; editModal.show(); }

    async function updateRole() {
      const id = document.getElementById('editId').value; const data = { name: document.getElementById('editName').value.trim(), description: document.getElementById('editDescription').value.trim() || null };
      try {
        const res = await fetch(`${API_BASE_URL}/api/v1/Roles/${id}`, { method:'PUT', headers: getAuthHeaders(), body: JSON.stringify(data) });
        let result; const ct = res.headers.get('content-type'); if (ct && ct.includes('application/json')) result = await res.json(); else { const t = await res.text(); result = { error: t, statusCode: res.status }; }
        updateResponseBox(result);
        if (res.ok) { showAlert('Role updated','success'); editModal.hide(); getAllRoles(); } else showAlert(`Error: ${result.message||result.error||'Failed to update'}`,'danger');
      } catch (err) { showAlert(`Error: ${err.message}`,'danger'); updateResponseBox({ error: err.message }); }
    }

    async function deleteRole(id, name) { if (!confirm(`Delete "${name}"?`)) return; try { const res = await fetch(`${API_BASE_URL}/api/v1/Roles/${id}`, { method:'DELETE', headers: getAuthHeaders() }); if (res.ok) { showAlert('Role deleted','success'); getAllRoles(); const ct = res.headers.get('content-type'); if (ct && ct.includes('application/json')) updateResponseBox(await res.json()); else updateResponseBox({ message: 'Deleted' }); } else { let result; const ct = res.headers.get('content-type'); if (ct && ct.includes('application/json')) result = await res.json(); else { const t = await res.text(); result = { error: t, statusCode: res.status }; } updateResponseBox(result); showAlert(`Error: ${result.message||result.error||'Failed to delete'}`,'danger'); } } catch (err) { showAlert(`Error: ${err.message}`,'danger'); updateResponseBox({ error: err.message }); }
  </script>
</body>
</html>