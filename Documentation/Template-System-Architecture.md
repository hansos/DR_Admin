# Email Template System - Architecture Diagram

## System Overview

```
???????????????????????????????????????????????????????????????????
?                     Email Template System                        ?
???????????????????????????????????????????????????????????????????

????????????????????????
?  Event Occurs        ?  (e.g., Domain Registered)
?  (DomainRegistered   ?
?   EventHandler)      ?
????????????????????????
           ?
           ? 1. Create Model
           ?
????????????????????????
? DomainRegistered     ?  { DomainName: "example.com",
? Model                ?    RegistrationDate: "2026-01-15",
????????????????????????    ... }
           ?
           ? 2. Call RenderMessage()
           ?
????????????????????????????????????????????????????????????????
?                    MessagingService                          ?
????????????????????????????????????????????????????????????????
? RenderMessage("DomainRegistered", EmailHtml, model)          ?
????????????????????????????????????????????????????????????????
           ?
           ???? 3a. Load Content Template ????
           ?                                  ?
           ?                    ????????????????????????????????
           ?                    ?    TemplateLoader            ?
           ?                    ?  (with Memory Cache)         ?
           ?                    ????????????????????????????????
           ?                               ?
           ?                               ?? Check Cache
           ?                               ?
           ?                               ?? Load from Disk
           ?                                  (if not cached)
           ?                                         ?
           ???? 3b. Load Master Template ????????????
           ?                                         ?
           ?                                         ?
    ???????????????????                  ???????????????????????
    ? Content Template?                  ?  Master Template    ?
    ? (message only)  ?                  ?  (layout/branding)  ?
    ?                 ?                  ?                     ?
    ? Templates/      ?                  ? Templates/Layouts/  ?
    ? DomainRegistered?                  ? email.html.master   ?
    ? /email.html.txt ?                  ? .txt                ?
    ???????????????????                  ???????????????????????
             ?                                      ?
             ? 4. Render Content                    ?
             ?                                      ?
    ??????????????????????                         ?
    ? TemplateRenderer   ?                         ?
    ? .Render()          ???????????????????????????
    ?                    ?
    ? Replace {{Name}}   ?
    ? with model values  ?
    ??????????????????????
             ?
             ? 5. Inject into Master
             ?
    ??????????????????????
    ? TemplateRenderer   ?
    ? .RenderWithMaster()?
    ?                    ?
    ? Replace {{Content}}?
    ? with rendered body ?
    ??????????????????????
             ?
             ? 6. Return Final HTML
             ?
    ???????????????????????????????????????????????
    ?  <html>                                     ?
    ?    <body>                                   ?
    ?      <header>Company Logo</header>          ?
    ?      <h2>Domain: example.com</h2>           ?
    ?      <p>Date: 2026-01-15</p>                ?
    ?      <footer>© 2026 Company</footer>        ?
    ?    </body>                                  ?
    ?  </html>                                    ?
    ???????????????????????????????????????????????
             ?
             ? 7. Send Email
             ?
    ???????????????????????
    ? EmailQueueService   ?
    ? .QueueEmailAsync()  ?
    ???????????????????????
```

---

## Component Responsibilities

### 1. Event Handlers
**Responsibility**: Orchestrate the email sending process
```csharp
DomainRegisteredEventHandler
?? Retrieve customer data
?? Create template model
?? Call MessagingService
?? Queue email for sending
```

### 2. MessagingService
**Responsibility**: High-level template rendering
```csharp
MessagingService
?? Determine channel file name
?? Load templates (content + master)
?? Convert model to dictionary
?? Coordinate rendering
```

### 3. TemplateLoader
**Responsibility**: File I/O and caching
```csharp
TemplateLoader
?? Check memory cache first
?? Load from disk if not cached
?? Cache for 10 minutes
?? Handle missing file errors
```

### 4. TemplateRenderer
**Responsibility**: String manipulation and rendering
```csharp
TemplateRenderer
?? Replace {{placeholders}}
?? Inject content into master
?? Convert model to dictionary
```

---

## Data Flow

```
?????????????????
? Event Occurs  ?
?????????????????
        ?
        ?
?????????????????????????????????????????????????????
? Step 1: Create Model                              ?
? ?????????????????????????????????????????????     ?
? var model = new DomainRegisteredModel {           ?
?     DomainName = "example.com",                   ?
?     RegistrationDate = "2026-01-15"               ?
? };                                                ?
?????????????????????????????????????????????????????
        ?
        ?
?????????????????????????????????????????????????????
? Step 2: Render Template                           ?
? ?????????????????????????????????????????????     ?
? var html = _messagingService.RenderMessage(       ?
?     "DomainRegistered",                           ?
?     MessageChannel.EmailHtml,                     ?
?     model                                         ?
? );                                                ?
?????????????????????????????????????????????????????
        ?
        ?
?????????????????????????????????????????????????????
? Step 3: Send Email                                ?
? ?????????????????????????????????????????????     ?
? await _emailService.QueueEmailAsync(              ?
?     new QueueEmailDto {                           ?
?         To = "customer@example.com",              ?
?         Subject = "Domain Registered",            ?
?         BodyHtml = html                           ?
?     }                                             ?
? );                                                ?
?????????????????????????????????????????????????????
```

---

## File Structure

```
Solution Root
?
??? DR_Admin/
?   ??? Program.cs                          ? DI Registration
?   ??? Workflow/
?       ??? Domain/
?           ??? EventHandlers/
?               ??? DomainRegisteredEventHandler.cs  ? Uses templates
?               ??? DomainExpiredEventHandler.cs     ? Uses templates
?
??? EmailSenderLib/
?   ??? Enums/
?   ?   ??? MessageChannel.cs              ? Channel types
?   ??? Templating/
?   ?   ??? TemplateRenderer.cs            ? Rendering logic
?   ?   ??? TemplateLoader.cs              ? File I/O + caching
?   ?   ??? MessagingService.cs            ? High-level API
?   ?   ??? Models/
?   ?       ??? DomainRegisteredModel.cs   ? Data model
?   ?       ??? DomainExpiredModel.cs      ? Data model
?   ??? EmailSenderLib.csproj              ? Added cache package
?
??? Templates/                              ? Template files
    ??? Layouts/
    ?   ??? email.html.master.txt
    ?   ??? email.text.master.txt
    ?   ??? sms.master.txt
    ??? DomainRegistered/
    ?   ??? email.html.txt
    ?   ??? email.text.txt
    ?   ??? sms.txt
    ??? DomainExpired/
        ??? email.html.txt
        ??? email.text.txt
        ??? sms.txt
```

---

## Caching Strategy

```
First Request:
???????????????
? Request     ?
? Template    ?
???????????????
       ?
       ?
????????????????      No      ???????????????
? Check Cache  ???????????????? Load from   ?
?              ?               ? Disk        ?
????????????????               ???????????????
       ?                              ?
       ? Cache Miss                   ?
       ?                              ?
       ?                              ?
       ?                       ????????????????
       ?                       ? Store in     ?
       ?                       ? Cache        ?
       ?                       ? (10 min TTL) ?
       ?                       ????????????????
       ?                              ?
       ????????????????????????????????
                     ?
                     ?
              ????????????????
              ? Return       ?
              ? Template     ?
              ????????????????

Subsequent Requests (within 10 min):
???????????????
? Request     ?
? Template    ?
???????????????
       ?
       ?
????????????????      Yes     ???????????????
? Check Cache  ???????????????? Return from ?
?              ?               ? Cache       ?
????????????????               ???????????????
                                (Fast - No I/O)
```

**Benefits**:
- First load: ~10ms (disk I/O)
- Cached loads: ~0.1ms (memory)
- Auto-refresh every 10 minutes
- No manual cache invalidation needed

---

## Template Resolution

```
RenderMessage("DomainRegistered", MessageChannel.EmailHtml, model)
        ?                              ?
        ?                              ?? Determines channel file
        ?
        ?
Channel Resolution:
???????????????????????????????????????????????????????????
? MessageChannel.EmailHtml  ? "email.html"                ?
? MessageChannel.EmailText  ? "email.text"                ?
? MessageChannel.Sms        ? "sms"                       ?
???????????????????????????????????????????????????????????
        ?
        ?
File Path Resolution:
???????????????????????????????????????????????????????????
? Content:  Templates/{MessageType}/{Channel}.txt         ?
? Master:   Templates/Layouts/{Channel}.master.txt        ?
???????????????????????????????????????????????????????????
        ?
        ?
Example:
???????????????????????????????????????????????????????????
? Content:  Templates/DomainRegistered/email.html.txt     ?
? Master:   Templates/Layouts/email.html.master.txt       ?
???????????????????????????????????????????????????????????
```

---

## Dependency Injection Hierarchy

```
Program.cs (Startup)
?
?? IMemoryCache (built-in)
?   ?
?   ??? TemplateLoader (singleton)
?           ?
?           ??? MessagingService (singleton)
?                   ?
?                   ??? Injected into Event Handlers (transient)
?                           ?
?                           ?? DomainRegisteredEventHandler
?                           ?? DomainExpiredEventHandler
```

**Lifetimes**:
- `IMemoryCache`: Singleton (app-wide)
- `TemplateLoader`: Singleton (shared cache)
- `MessagingService`: Singleton (stateless)
- Event Handlers: Transient (per-request)

---

## Template Rendering Pipeline

```
Input: 
  MessageType = "DomainRegistered"
  Channel = MessageChannel.EmailHtml
  Model = { DomainName: "example.com", ... }

Pipeline:
??????????????????????????????????????????????????????????????
? Step 1: Load Content Template                             ?
? ????????????????????????????????????????????????????       ?
? File: Templates/DomainRegistered/email.html.txt           ?
? Content:                                                   ?
?   <h2>Domain: {{DomainName}}</h2>                         ?
??????????????????????????????????????????????????????????????
              ?
              ?
??????????????????????????????????????????????????????????????
? Step 2: Render Content (Replace Placeholders)             ?
? ????????????????????????????????????????????????????       ?
? Output:                                                    ?
?   <h2>Domain: example.com</h2>                            ?
??????????????????????????????????????????????????????????????
              ?
              ?
??????????????????????????????????????????????????????????????
? Step 3: Load Master Template                              ?
? ????????????????????????????????????????????????????       ?
? File: Templates/Layouts/email.html.master.txt             ?
? Content:                                                   ?
?   <html>                                                   ?
?     <body>                                                 ?
?       <header>Logo</header>                               ?
?       {{Content}}                                         ?
?       <footer>© 2026</footer>                             ?
?     </body>                                               ?
?   </html>                                                 ?
??????????????????????????????????????????????????????????????
              ?
              ?
??????????????????????????????????????????????????????????????
? Step 4: Inject Content into Master                        ?
? ????????????????????????????????????????????????????       ?
? Output:                                                    ?
?   <html>                                                   ?
?     <body>                                                 ?
?       <header>Logo</header>                               ?
?       <h2>Domain: example.com</h2>                        ?
?       <footer>© 2026</footer>                             ?
?     </body>                                               ?
?   </html>                                                 ?
??????????????????????????????????????????????????????????????
              ?
              ?
         Final HTML Email
```

---

## Extension Points

### Add New Message Type

```
1. Create folder:
   Templates/NewMessageType/

2. Add templates:
   Templates/NewMessageType/email.html.txt
   Templates/NewMessageType/email.text.txt
   Templates/NewMessageType/sms.txt

3. Create model:
   EmailSenderLib/Templating/Models/NewMessageTypeModel.cs

4. Use in code:
   var model = new NewMessageTypeModel { ... };
   var html = _messagingService.RenderMessage(
       "NewMessageType", 
       MessageChannel.EmailHtml, 
       model
   );
```

### Add New Channel

```
1. Add to enum:
   public enum MessageChannel
   {
       ...
       Push,  // New channel
   }

2. Add master template:
   Templates/Layouts/push.master.txt

3. Add channel resolution:
   var channelFileName = channel switch
   {
       ...
       MessageChannel.Push => "push",
   };

4. Add to LoadMasterTemplate:
   MessageChannel.Push => Path.Combine(..., "push.master.txt"),
```

---

## Performance Characteristics

```
Operation                    Time        Notes
?????????????????????????????????????????????????????????????
Load template (first time)   ~10ms      Disk I/O
Load template (cached)        ~0.1ms     Memory access
Render template (small)       ~1ms       Regex + string ops
Render template (large)       ~5ms       More placeholders
Full render (cached)          ~2ms       Load + render
Full render (uncached)        ~12ms      Load + render
Cache expiration              10 min     Configurable
Memory per template           ~5KB       Typical size
```

**Optimization Tips**:
- Keep templates under 50KB
- Minimize number of placeholders
- Use caching (enabled by default)
- Consider pre-warming cache on startup

---

## Error Handling Flow

```
MessagingService.RenderMessage()
        ?
        ?? Try Load Content Template
        ?   ?
        ?   ?? Success ? Continue
        ?   ?
        ?   ?? FileNotFoundException
        ?       ?? Log error
        ?       ?? Throw exception
        ?
        ?? Try Load Master Template
        ?   ?
        ?   ?? Success ? Continue
        ?   ?
        ?   ?? FileNotFoundException
        ?       ?? Log error
        ?       ?? Throw exception
        ?
        ?? Try Render
            ?
            ?? Success ? Return HTML
            ?
            ?? Exception
                ?? Log error
                ?? Throw exception

Event Handler catches exception:
        ?
        ?? Log error with context
        ?? Email not sent (fail gracefully)
        ?? Error recorded in logs
```

---

## Summary

This architecture provides:
? **Separation of Concerns** - Templates separate from code
? **Performance** - In-memory caching
? **Flexibility** - Easy to add new templates
? **Maintainability** - Designers can edit HTML
? **Type Safety** - Strongly-typed models
? **Scalability** - Stateless services, cached templates

For more details, see:
- `Templates/README.md`
- `Documentation/Email-Template-System-QuickStart.md`
